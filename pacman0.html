<link rel="stylesheet" href="style.css">

<div class="centrado">
  <canvas id="canvas" width="400" height="400" tabindex="1"></canvas>

</div>
<h2 id="puntos"></h2>
<h2 id="tiempo"></h2>

<script src="web-lib/processing.js"></script>
<script src="web-lib/functional-light.js"></script>
<script>

  //Vamos a usar http://processingjs.org/
  // o https://p5js.org/reference/
  // Importamos las librerias
  let { append, cons, first, isEmpty, isList, length, rest, deepCopy, concat } = functionalLight;
  
  let pacman1 = null;
  let pacman2 = null;
  let pacman3 = null;
  let barriles = null;
  let f1 = null;
  let f1_2 = null;
  let f2 = null;
  let f2_2 = null;
  let f3 = null;
  let f3_2 = null;
  let f4 = null;
  let f4_2 = null;
  let portal = null;


  function make(data, attribute) {
    return Object.assign({}, data, attribute);
  }

  function forEach(l, f, index = 0) {
    if (!isEmpty(l)) {
      f(first(l), index);
      forEach(rest(l), f, index + 1);
    }
  }

//Funcion para crear el mapa
  function createMap(processing, mapa, world){
    forEach(mapa, (row, i) => {
        forEach(row, (cell, j) => {
          if (cell == 0) {
            activo = true;
            processing.fill(0, 0, 0);
            processing.rect(j * SIZE, i * SIZE, SIZE, SIZE);
            processing.fill(57, 255, 20);
            processing.ellipse(j * SIZE + SIZE / 2, i * SIZE + SIZE / 2, SIZE / 3 , SIZE / 3 );
          } if(cell == 1) {
            processing.fill(0, 0, 200);
            processing.rect(j * SIZE, i * SIZE, SIZE, SIZE);
          } if (cell == 3) {
            processing.fill(0, 0, 0);
          } if (cell == 6) {
            processing.fill(0, 0, 0);
            
            if (world.time % 2 == 0)
              processing.image(portal, j * SIZE + 5 , i * SIZE + 5 , 40 , 40 );
            else
              processing.image(portal, j * SIZE + 7.5 , i * SIZE + 7.5 , 35 , 35 );
          } if(cell == 7) {
            processing.fill(0, 200, 200);
            if (world.time % 2 == 0)
              processing.image(barriles, j * SIZE, i * SIZE , 45, 45);
            else
              processing.image(barriles, j * SIZE, i * SIZE , 50, 50);
          } if(cell == 9) {
            processing.fill(0, 200, 200);
          } if(cell == 10) {
            processing.fill(0, 200, 200);
          } if(cell == 8){
            processing.fill(0, 200, 200);
          } if(cell == 15){
              if(world.barrilAnimacion == 1 ) processing.image(explosion1, j * SIZE - 10, i * SIZE - 10)
              if(world.barrilAnimacion == 2 ) processing.image(explosion2, j * SIZE - 10, i * SIZE - 10)
          }
        } );
      });

      if (mapa[0][0] == 1)
        processing.image(bloque, x, y)

  }



  //Funciones para movimiento 

  
  function movimiento(world){
    const time1 = world.time;
    const animacion = world.pacmanAnimacion;

      if(teletransportarLEFT(world)) return {posicionPacmanx: 1, pacmanx: 0 * SIZE }
      if(teletransportarRIGHT(world)) return {posicionPacmanx: 23, pacmanx: 22 * SIZE }
      if(world.ejex && world.xMove && (colisionRIGHT(world))) return { ejex:false, ejey: false };
      if(world.ejex && !world.xMove && (colisionLEFT(world))) return  {  ejex:false, ejey: false};
      if(world.ejey && world.yMove && (colisionUP(world))) return  {  ejex:false, ejey: false };
      if(world.ejey && !world.yMove && (colisionDOWN(world))) return {  ejex:false, ejey: false}; 

      if(world.ejex && world.xMove) return { pacmanx: world.pacmanx + SIZE, posicionPacmanx: world.posicionPacmanx + 1};
      if(world.ejex && !world.xMove) return {pacmanx: world.pacmanx - SIZE, posicionPacmanx: world.posicionPacmanx - 1};
      if(world.ejey && world.yMove) return { pacmany: world.pacmany - SIZE, posicionPacmany: world.posicionPacmany - 1};
      if(world.ejey && !world.yMove) return {pacmany: world.pacmany + SIZE, posicionPacmany: world.posicionPacmany + 1};
      if(!world.ejey && !world.ejex) return {time: time1 + 1, pacmanAnimacion: animacion + 1};
  }

  //PACMAN

  function pintarPacman(processing,world){

    if (world.pacmanAnimacion == 1) {
      if (!world.ejey && !world.ejex) processing.image(pacman1, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejex && world.xMove) processing.image(pacman1, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejex && !world.xMove) processing.image(pacman1_left, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejey && world.yMove) processing.image(pacman1_up, world.pacmanx +5 , world.pacmany -5, 150 , 100);
      if (world.ejey && !world.yMove) processing.image(pacman1_down, world.pacmanx + 5 , world.pacmany - 5, 150 , 100);
    }

    if (world.pacmanAnimacion == 2) {
      if (!world.ejey && !world.ejex) processing.image(pacman2, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejex && world.xMove) processing.image(pacman2,  world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejex && !world.xMove) processing.image(pacman2_left, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejey && world.yMove) processing.image(pacman2_up, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejey && !world.yMove) processing.image(pacman2_down, world.pacmanx , world.pacmany, 150 , 100);
    }
    if (world.pacmanAnimacion == 3) {
      if (!world.ejey && !world.ejex) processing.image(pacman3, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejex && world.xMove) processing.image(pacman3,  world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejex && !world.xMove) processing.image(pacman3_left, world.pacmanx , world.pacmany, 150 , 100);
      if (world.ejey && world.yMove) processing.image(pacman3_up, world.pacmanx , world.pacmany , 150 , 100);
      if (world.ejey && !world.yMove) processing.image(pacman3_down, world.pacmanx , world.pacmany , 150 , 100);
    }


  }

  function animacionPacman(world){
    if(world.pacmanAnimacion < 3) return {pacmanAnimacion: world.pacmanAnimacion + 1};
    return {pacmanAnimacion: 1};
  }



  //COMER

  function comer(processing, world, mapa){
    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 0){
      Object.assign(deepCopy(mapa),mapa[world.posicionPacmany][world.posicionPacmanx] = 2);
    }

    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 7){
      Object.assign(deepCopy(mapa),mapa[world.posicionPacmany][world.posicionPacmanx] = 15);
    }

    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 6){
      Object.assign(deepCopy(mapa),mapa[world.posicionPacmany][world.posicionPacmanx] = 11);
    }

    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 11){
      Object.assign(deepCopy(mapa),mapa[world.posicionPacmany][world.posicionPacmanx] = 12);
    }

  }


//EXPLOTAR

  function explotar(world){
      if(world.barrilAnimacion < 5) return {barrilAnimacion: world.barrilAnimacion + 1}
      return { barrilAnimacion:1}
  }



//PUNTOS

  function acumularPuntos(list, accum){
    if(isEmpty(list)) {return accum;}
    if((first(list)) == 2){
        return acumularPuntos(rest(list), accum + 10) 
    } else if(first(list) == 15){
        return acumularPuntos(rest(list), accum + 500) 
    } else {
        return acumularPuntos(rest(list), accum);
    }
  }

  function acumuladoTotal(list, accum){
    if(isEmpty(list)) return accum;
    return acumularPuntos(first(list),accum) + acumuladoTotal(rest(list),accum);
  }

//COLISIONES

  function colisionUP(world){
    if(mapa[world.posicionPacmany - 1][world.posicionPacmanx] == 1) return true;
    return false;
  }

  function colisionDOWN(world){
    if(mapa[world.posicionPacmany + 1][world.posicionPacmanx] == 1) return true;
    return false;
  }

  function colisionRIGHT(world){
    if(mapa[world.posicionPacmany][world.posicionPacmanx + 1] == 1) return true;
    return false;
  }

  function colisionLEFT(world){
    if(mapa[world.posicionPacmany][world.posicionPacmanx - 1] == 1) return true;
    return false;
  }

  function teletransportarRIGHT(world){
    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 4 ) return true;
    return false;
  }

  function teletransportarLEFT(world){
    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 10 ) return true;
    return false;
  }


  //FANTASMAS

  function pintarFantasmas(processing,world){
    if(world.modoComer){
      if (world.time % 2 == 0)
        processing.image(ff, world.f1.x  + 5, world.f1.y, 43, 43);
      else 
        processing.image(ff_2, world.f1.x + 5 , world.f1.y, 43, 43);

      if (world.time % 2 == 0)
        processing.image(ff, world.f2.x + 5, world.f2.y, 43, 43);
      else 
        processing.image(ff_2, world.f2.x + 5 , world.f2.y, 43, 43);

      if (world.time % 2 == 0)
        processing.image(ff, world.f3.x + 5 , world.f3.y, 43, 43);
      else 
        processing.image(ff_2, world.f3.x  + 5, world.f3.y, 43, 43);

      if (world.time % 2 == 0)
        processing.image(ff, world.f4.x + 5 , world.f4.y, 43, 43);
      else 
        processing.image(ff_2, world.f4.x + 5 , world.f4.y, 43, 43);

    } else {

      if (world.time % 2 == 0)
        processing.image(f1, world.f1.x , world.f1.y, 47, 47);
      else 
        processing.image(f1_2, world.f1.x , world.f1.y, 47, 47);

      if (world.time % 2 == 0)
        processing.image(f2, world.f2.x, world.f2.y, 50, 50);
      else 
        processing.image(f2_2, world.f2.x , world.f2.y, 50, 50);

      if (world.time % 2 == 0)
        processing.image(f3, world.f3.x , world.f3.y, 50, 50);
      else 
        processing.image(f3_2, world.f3.x , world.f3.y, 50, 50);

      if (world.time % 2 == 0)
        processing.image(f4, world.f4.x , world.f4.y, 50, 50);
      else 
        processing.image(f4_2, world.f4.x , world.f4.y, 50, 50);
    }



  }


  function comerFantasmasF(world){
    if(world.modoComer){
      if(world.comerFantasmas <= 30 && world.comerFantasmas>1){
        return {comerFantasmas: world.comerFantasmas - 1};
      } else {
        return {modoComer: false, comerFantasmas: 30};
      }
    }
  }

  function modoComerFantasmas(world){
    if(mapa[world.posicionPacmany][world.posicionPacmanx] == 11){
      return {modoComer: true};
    }
  }



  //TIEMPO

  function tiempoReal(world){
    if(world.time%6 == 0) return {time_real: world.time_real + 1};
  }


  /**
   * Ejemplo de animación usando los evento de reloj del procesador. Es la animación mas simple. 
   * No requiere interacción con el usuario
   */
  const WIDTH = 1250;
  const HEIGHT = 750;
  const SIZE = 50;
  const mapa=[[5,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,5,5],
              [5,5,5,1,0,0,0,0,0,0,0,7,1,7,0,0,0,0,0,0,0,1,5,5,5],
              [1,1,1,1,0,6,1,0,0,0,0,0,1,0,0,0,0,0,1,6,0,1,1,1,1],
              [1,7,0,0,0,1,1,0,1,1,0,0,6,0,0,1,1,0,1,1,0,0,0,7,1],
              [1,0,0,0,0,0,0,0,1,0,0,1,1,1,0,0,1,0,0,0,0,0,0,0,1],
              [1,0,1,0,1,0,1,0,1,0,0,0,7,0,0,0,1,0,1,0,1,0,1,0,1],
              [4,0,1,0,1,0,1,0,0,0,1,1,9,1,1,0,0,0,1,0,1,0,1,0,10],
              [4,0,0,0,0,0,0,7,1,0,1,9,9,9,1,0,1,7,0,0,0,0,0,0,10],
              [4,0,1,1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1,1,0,10],
              [1,0,1,1,0,1,1,0,0,0,0,0,8,0,0,0,0,0,1,1,0,1,1,0,1],
              [1,0,1,7,0,0,1,0,1,0,0,1,1,1,0,0,1,0,1,0,0,7,1,0,1],
              [1,0,0,0,1,0,0,0,1,0,0,0,6,0,0,0,1,0,0,0,1,0,0,0,1],
              [1,1,1,1,6,0,1,0,1,1,1,0,1,0,1,1,1,0,1,0,6,1,1,1,1],
              [5,5,5,1,0,0,0,0,0,0,0,7,1,7,0,0,0,0,0,0,0,1,5,5,5],
              [5,5,5,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,5,5,5]];

  function sketchProc(processing) {
    /**
     * Esto se llama antes de iniciar el juego
     */
    processing.setup = function () {
      processing.frameRate(6);
      processing.size(WIDTH, HEIGHT);
      barriles = processing.loadImage('images/barriles2.2.png');
      explosion1 = processing.loadImage('images/explosion1.png');
      explosion2 = processing.loadImage('images/explosion2.png');
      f1 = processing.loadImage('images/f1.png');
      f1_2 = processing.loadImage('images/f1-2.png');
      f2 = processing.loadImage('images/f2.png');
      f2_2 = processing.loadImage('images/f2-2.png');
      f3 = processing.loadImage('images/f3.png');
      f3_2 = processing.loadImage('images/f3-2.png');
      f4 = processing.loadImage('images/f4.png');
      f4_2 = processing.loadImage('images/f4-2.png');
      ff = processing.loadImage('images/ff.png');
      ff_2 = processing.loadImage('images/ff-2.png');
      pacman1 = processing.loadImage('images/pacman1.png');
      pacman1_left = processing.loadImage('images/pacman1_left.png');
      pacman1_down = processing.loadImage('images/pacman1_down.png');
      pacman1_up = processing.loadImage('images/pacman1_up.png');
      pacman2 = processing.loadImage('images/pacman2.png');
      pacman2_left = processing.loadImage('images/pacman2_left.png');
      pacman2_down = processing.loadImage('images/pacman2_down.png');
      pacman2_up = processing.loadImage('images/pacman2_up.png');
      pacman3 = processing.loadImage('images/pacman3.png');
      pacman3_left = processing.loadImage('images/pacman3_left.png');
      pacman3_down = processing.loadImage('images/pacman3_down.png');
      pacman3_up = processing.loadImage('images/pacman3_up.png');
      portal = processing.loadImage("images/portal.gif");
      //fonts
      font1 = processing.createFont("fonts/Gamer.tff")

      processing.state = { 
        time: 0,
        time_real: 0,
        puntos: 0,
        pacmanx: 11 * SIZE, 
        pacmany: 8.7 * SIZE,
        posicionPacmanx: 12,
        posicionPacmany: 9, 
        pacmanAnimacion: 1,
        modoComer: false,
        comerFantasmas: 30,
        barrilExplosion: true,
        barrilAnimacion: 1,
        comerPacman : false,
        f1: { x: 13 * SIZE + 2, y: 7 * SIZE + 2 },
        f2: { x: 12 * SIZE, y: 6 * SIZE },
        f3: { x: 12 * SIZE, y: 7 * SIZE },
        f4: { x: 11 * SIZE, y: 7 * SIZE },
        timeFantasmas: 0,
        ejex: false,
        ejey: false,
        xMove: true,
        yMove: true,

         
      };
    }
    // Dibuja algo en el canvas. Aqui se pone todo lo que quieras pintar


    processing.drawGame = function (world) {
      processing.background(0, 0, 0);
      //Mapa
      createMap(processing,mapa,world);


      //COMER

      comer(processing,world, mapa);
    
      //Fantasmas

      pintarFantasmas(processing,world);

      console.log(world.comerFantasmas);
      console.log(world.modoComer);

      //console.log(world.comerFantasmas)
      //Pacman
   
      document.getElementById("puntos").innerHTML = acumuladoTotal(mapa,0);

      document.getElementById("tiempo").innerHTML = world.time_real;

  
      pintarPacman(processing,world);

      //processing.image(pacman2,  0,0);

      //processing.image(f1, 13 * SIZE + 2 , 7 * SIZE + 2, 48, 48);
      //processing.image(f2, 12 * SIZE , 6 * SIZE, 50, 50);
      //processing.image(f3, 12 * SIZE , 7 * SIZE, 50, 50);
      //processing.image(f4, 11 * SIZE , 7 * SIZE, 50 ,50);


    }

    processing.onTic = function (world) {
       return make(world, Object.assign(movimiento(world), { time: world.time + 1}, tiempoReal(world),animacionPacman(world),explotar(world), modoComerFantasmas(world), comerFantasmasF(world)));
    }




    processing.onKeyEvent = function (world, keyCode) {
      switch (keyCode) {
        case processing.UP:
          return make(world, { ejex:false, ejey: true, yMove: true });
          break;
        case processing.DOWN:
          return make(world, { ejex:false, ejey: true, yMove: false });
          break;
        case processing.LEFT:
          return make(world, { ejex: true, ejey: false, xMove: false });
          break;
        case processing.RIGHT:
          return make(world, { ejex: true, ejey: false, xMove: true });
          break;
      }
    }

    processing.onMouseEvent = function (world, event) {
      return make(world, {});
    }

    // ******************** De aquí hacia abajo no debe cambiar nada. ********************

    // Esta es la función que pinta todo. Se ejecuta 60 veces por segundo. 
    // No cambie esta función. Su código debe ir en drawGame
    processing.draw = function () {
      processing.drawGame(processing.state);
      processing.state = processing.onTic(processing.state);
    };

    // Esta función se ejecuta cada vez que presionamos una tecla. 
    // No cambie esta función. Su código debe ir en onKeyEvent
    processing.keyPressed = function () {
      processing.state = processing.onKeyEvent(processing.state, processing.keyCode);
    }

    // Esta función se ejecuta cada vez movemos el mouse. 
    // No cambie esta función. Su código debe ir en onKeyEvent
    processing.mouseMoved = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "move", mouseX: processing.mouseX, mouseY: processing.mouseY });
    }

    // Estas funciones controlan los eventos del mouse. 
    // No cambie estas funciones. Su código debe ir en OnMouseEvent
    processing.mouseClicked = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "click", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }

    processing.mouseDragged = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "drag", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }

    processing.mousePressed = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "press", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }

    processing.mouseReleased = function () {
      processing.state = processing.onMouseEvent(processing.state,
        { action: "release", mouseX: processing.mouseX, mouseY: processing.mouseY, mouseButton: processing.mouseButton });
    }
    // Fin de los eventos del mouse
  }
  var canvas = document.getElementById("canvas");
  document.getElementById("canvas").focus();
  // Adjuntamos nuestro sketch al framework de processing
  var processingInstance = new Processing(canvas, sketchProc);
</script>



